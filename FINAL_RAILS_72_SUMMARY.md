# üéØ –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–í–û–î–ö–ê: Discourse Telegram Auth Plugin v1.1.8

## üìÖ –î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: 6 –∏—é–Ω—è 2025 –≥.
## ‚úÖ –°—Ç–∞—Ç—É—Å: –ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–¢–û–í –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ

---

## üöÄ –ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ Rails 7.2+ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞!**

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
No such middleware to insert before: ActionDispatch::ContentSecurityPolicy::Middleware
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
‚úÖ –ü–ª–∞–≥–∏–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
‚úÖ Middleware —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
‚úÖ –û–±–µ—Å–ø–µ—á–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
```

---

## üìã –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û

### 1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Rails 7.2+
- –í—ã—è–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å `ActionDispatch::ContentSecurityPolicy::Middleware`

### 2. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ
- –°–æ–∑–¥–∞–Ω –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Å `TelegramCSPMiddleware`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è middleware
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω fallback –º–µ—Ö–∞–Ω–∏–∑–º
- –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏
- –í–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ `1.1.8`
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## üîß –ö–õ–Æ–ß–ï–í–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í plugin.rb

```ruby
# –ë–´–õ–û (–Ω–µ—Ä–∞–±–æ—á–µ–µ –≤ Rails 7.2+):
Rails.application.config.middleware.insert_before ActionDispatch::ContentSecurityPolicy::Middleware, Class.new do
  # ...
end

# –°–¢–ê–õ–û (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å Rails 7.2+):
class TelegramCSPMiddleware
  def initialize(app); @app = app; end
  def call(env)
    if env['PATH_INFO'] == '/auth/telegram' || env['PATH_INFO'].start_with?('/auth/telegram')
      env['action_dispatch.content_security_policy'] = nil
      env['action_dispatch.content_security_policy_report_only'] = nil
    end
    @app.call(env)
  end
end

begin
  if defined?(ActionDispatch::ContentSecurityPolicy::Middleware)
    Rails.application.config.middleware.insert_before ActionDispatch::ContentSecurityPolicy::Middleware, TelegramCSPMiddleware
  else
    Rails.application.config.middleware.use TelegramCSPMiddleware
  end
rescue => e
  Rails.logger.warn("TelegramAuth: Could not register CSP middleware: #{e.message}")
  Rails.application.config.middleware.use TelegramCSPMiddleware
end
```

---

## üìä –ò–°–¢–û–†–ò–Ø –í–ï–†–°–ò–ô

| –í–µ—Ä—Å–∏—è | –î–∞—Ç–∞ | –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
|--------|------|----------------|
| 1.1.1 | - | –ò—Å—Ö–æ–¥–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏ |
| 1.1.2 | 6 –∏—é–Ω—è | –§–∏–∫—Å reconnect –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ |
| 1.1.3 | 6 –∏—é–Ω—è | –§–∏–∫—Å CSP –æ—à–∏–±–æ–∫ |
| 1.1.4 | 6 –∏—é–Ω—è | –§–∏–∫—Å –ø–µ—Ä–µ–≤–æ–¥–æ–≤ |
| 1.1.5 | 6 –∏—é–Ω—è | –£–ª—É—á—à–µ–Ω–∏–µ CSP strict-dynamic |
| 1.1.6 | 6 –∏—é–Ω—è | –§–∏–∫—Å —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ |
| 1.1.7 | 6 –∏—é–Ω—è | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ —Ñ–∏–∫—Å—ã |
| **1.1.8** | **6 –∏—é–Ω—è** | **üéØ Rails 7.2+ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** |

---

## üéØ –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ

### ‚úÖ –í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã:
1. **Rails 7.2+ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** ‚Üí ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
2. **–ó–∞–≤–∏—Å–∞–Ω–∏–µ –Ω–∞ reconnect —Å—Å—ã–ª–∫–∞—Ö** ‚Üí ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û  
3. **Content Security Policy –æ—à–∏–±–∫–∏** ‚Üí ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
4. **–ü–µ—Ä–µ–≤–æ–¥—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è** ‚Üí ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
5. **–°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏** ‚Üí ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

### üìÅ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞:
- `CRITICAL_RAILS_72_FIX.md` - –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Ñ–∏–∫—Å–µ
- `RAILS_72_COMPATIBILITY_FIX.md` - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- –û–±–Ω–æ–≤–ª–µ–Ω `README.md`

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ production:**
   ```bash
   cd /var/www/discourse
   su discourse -c 'bundle exec rake db:migrate'
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:**
   - –û—Ç–∫—Ä—ã—Ç—å `/auth/telegram`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É Telegram –≤–∏–¥–∂–µ—Ç–∞
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫ middleware
   - –£–±–µ–¥–∏—Ç—å—Å—è –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç–µ CSP

---

**üéâ –ü–õ–ê–ì–ò–ù –ì–û–¢–û–í –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ –í DISCOURSE –° RAILS 7.2+!**
