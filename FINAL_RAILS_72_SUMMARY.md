# üéØ –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–í–û–î–ö–ê: Discourse Telegram Auth Plugin v1.1.9

## üìÖ –î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: 6 –∏—é–Ω—è 2025 –≥.
## ‚úÖ –°—Ç–∞—Ç—É—Å: –ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–¢–û–í –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ

---

## üöÄ –ü–†–û–ë–õ–ï–ú–´ –†–ï–®–ï–ù–´

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ Rails 7.2+ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!**

### 1Ô∏è‚É£ –ü–µ—Ä–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞ - Middleware –Ω–µ –Ω–∞–π–¥–µ–Ω:
```
No such middleware to insert before: ActionDispatch::ContentSecurityPolicy::Middleware
```
**‚úÖ –†–ï–®–ï–ù–û:** –°–æ–∑–¥–∞–Ω –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Å —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

### 2Ô∏è‚É£ –í—Ç–æ—Ä–∞—è –ø—Ä–æ–±–ª–µ–º–∞ - –ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–π —Å—Ç–µ–∫ middleware:
```
FrozenError: can't modify frozen Array
```
**‚úÖ –†–ï–®–ï–ù–û:** –ü–µ—Ä–µ–Ω–æ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ middleware –≤ —Ä–∞–Ω–Ω—é—é —Ñ–∞–∑—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

---

## üìã –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û

### 1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–≤—É—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º
- –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Rails 7.2+ middleware API
- –ó–∞–º–æ—Ä–æ–∑–∫–∞ —Å—Ç–µ–∫–∞ middleware –≤ `after_initialize`

### 2. –î–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ

#### –≠—Ç–∞–ø 1 (v1.1.8):
- –°–æ–∑–¥–∞–Ω –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Å `TelegramCSPMiddleware`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è middleware
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω fallback –º–µ—Ö–∞–Ω–∏–∑–º

#### –≠—Ç–∞–ø 2 (v1.1.9):
- –ü–µ—Ä–µ–Ω–æ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ middleware –∏–∑ `after_initialize`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ç–æ—á–∫–∏ –≤—Å—Ç–∞–≤–∫–∏ `ActionDispatch::Flash`
- –£–ø—Ä–æ—â–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- –í–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ `1.1.9`
- –°–æ–∑–¥–∞–Ω–∞ –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ —Ñ–∏–∫—Å–∞—Ö

---

## üîß –§–ò–ù–ê–õ–¨–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í plugin.rb

```ruby
# –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï (v1.1.9):

# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º middleware –î–û after_initialize (–∏–∑–±–µ–≥–∞–µ–º FrozenError)
class ::TelegramCSPMiddleware
  def initialize(app)
    @app = app
  end
  
  def call(env)
    if env['PATH_INFO'] == '/auth/telegram' || env['PATH_INFO'].start_with?('/auth/telegram')
      env['action_dispatch.content_security_policy'] = nil
      env['action_dispatch.content_security_policy_report_only'] = nil
    end
    @app.call(env)
  end
end

# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Ç–æ—á–∫—É –≤—Å—Ç–∞–≤–∫–∏
Rails.application.config.middleware.insert_after ActionDispatch::Flash, TelegramCSPMiddleware

after_initialize do
  # –¢–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥—ã –∏ —Ä–æ—É—Ç—ã - middleware —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
  ::TelegramAuthenticator.register_translations
  # ... —Ä–æ—É—Ç—ã –∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
end
```

---

## üìä –ò–°–¢–û–†–ò–Ø –í–ï–†–°–ò–ô

| –í–µ—Ä—Å–∏—è | –î–∞—Ç–∞ | –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
|--------|------|----------------|
| 1.1.1-1.1.7 | 6 –∏—é–Ω—è | –ë–∞–∑–æ–≤—ã–µ —Ñ–∏–∫—Å—ã (reconnect, CSP, –ø–µ—Ä–µ–≤–æ–¥—ã, —Å–∏–Ω—Ç–∞–∫—Å–∏—Å) |
| **1.1.8** | **6 –∏—é–Ω—è** | **Rails 7.2+ middleware API** |
| **1.1.9** | **6 –∏—é–Ω—è** | **üéØ Frozen middleware stack** |

---

## üéØ –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ

### ‚úÖ –í–°–ï –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã:
1. **Rails 7.2+ middleware API** ‚Üí ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û (v1.1.8)
2. **–ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–π —Å—Ç–µ–∫ middleware** ‚Üí ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û (v1.1.9)  
3. **–ó–∞–≤–∏—Å–∞–Ω–∏–µ –Ω–∞ reconnect —Å—Å—ã–ª–∫–∞—Ö** ‚Üí ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û  
4. **Content Security Policy –æ—à–∏–±–∫–∏** ‚Üí ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
5. **–ü–µ—Ä–µ–≤–æ–¥—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è** ‚Üí ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
6. **–°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏** ‚Üí ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

### üìÅ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞:
- `FROZEN_MIDDLEWARE_FIX.md` - –æ—Ç—á–µ—Ç –æ —Ñ–∏–∫—Å–µ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω–æ–≥–æ —Å—Ç–µ–∫–∞
- `CRITICAL_RAILS_72_FIX.md` - –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Ñ–∏–∫—Å middleware
- `RAILS_72_COMPATIBILITY_FIX.md` - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- –û–±–Ω–æ–≤–ª–µ–Ω `README.md`

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ production:**
   ```bash
   cd /var/www/discourse
   su discourse -c 'bundle exec rake db:migrate'
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:**
   - –û—Ç–∫—Ä—ã—Ç—å `/auth/telegram`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É Telegram –≤–∏–¥–∂–µ—Ç–∞
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫ middleware
   - –£–±–µ–¥–∏—Ç—å—Å—è –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç–µ CSP

---

**üéâ –ü–õ–ê–ì–ò–ù –ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–¢–û–í –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ –í DISCOURSE –° RAILS 7.2+!**

*–í—Å–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Rails 7.2+ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã.*
