# üîí –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –° CONTENT SECURITY POLICY

## –í–µ—Ä—Å–∏—è 1.1.3 - –†–µ—à–µ–Ω–∏–µ CSP –ø—Ä–æ–±–ª–µ–º

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –≤—ã—è—Å–Ω–∏–ª–æ—Å—å, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –∑–∞–∫–ª—é—á–∞–ª–∞—Å—å –Ω–µ –≤ `reconnect=true` –ø–∞—Ä–∞–º–µ—Ç—Ä–µ, –∞ –≤ **Content Security Policy (CSP)** –æ—à–∏–±–∫–∞—Ö:

```
Content-Security-Policy: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è (script-src-elem) 
–Ω–∞ https://telegram.org/js/telegram-widget.js?4, –ø–æ—Å–∫–æ–ª—å–∫—É –æ–Ω –Ω–∞—Ä—É—à–∞–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –¥–∏—Ä–µ–∫—Ç–∏–≤—É: 
¬´script-src 'strict-dynamic'¬ª
```

### –ü–µ—Ä–≤–æ–ø—Ä–∏—á–∏–Ω–∞
1. **CSP –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞**: Discourse –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∑–∞–≥—Ä—É–∑–∫—É Telegram –≤–∏–¥–∂–µ—Ç–∞ –∏–∑-–∑–∞ —Å—Ç—Ä–æ–≥–æ–π CSP –ø–æ–ª–∏—Ç–∏–∫–∏
2. **–ù–µ–ø–æ–ª–Ω–∞—è CSP –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: –ü–ª–∞–≥–∏–Ω –∏–º–µ–ª –±–∞–∑–æ–≤—É—é CSP –Ω–∞—Å—Ç—Ä–æ–π–∫—É, –Ω–æ –æ–Ω–∞ –±—ã–ª–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ HTML —à–∞–±–ª–æ–Ω–∞**: –ù–µ –±—ã–ª–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è Telegram –≤–∏–¥–∂–µ—Ç–∞

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ

#### 1. –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è CSP –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```ruby
extend_content_security_policy(
  script_src: [
    'https://telegram.org/js/telegram-widget.js',
    'https://telegram.org',
    "'unsafe-inline'"
  ],
  connect_src: [
    'https://telegram.org',
    'https://*.telegram.org'
  ],
  frame_src: [
    'https://oauth.telegram.org',
    'https://telegram.org'
  ]
)
```

#### 2. –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π HTML —à–∞–±–ª–æ–Ω
–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: `app/views/omniauth_callbacks/telegram.html.erb`
- –°–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É Telegram –≤–∏–¥–∂–µ—Ç–∞
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç `reconnect=true` –ø–∞—Ä–∞–º–µ—Ç—Ä
- –í–∫–ª—é—á–∞–µ—Ç –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

#### 3. –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–æ—É—Ç–æ–≤
```ruby
get '/auth/telegram' => 'telegram_auth#show'              # –ü–æ–∫–∞–∑ –≤–∏–¥–∂–µ—Ç–∞
get '/auth/telegram/callback' => 'users/omniauth_callbacks#telegram'  # Callback
delete '/auth/telegram/revoke' => 'users/omniauth_callbacks#telegram_revoke'  # –û—Ç–∫–ª—é—á–µ–Ω–∏–µ
```

#### 4. –ù–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä TelegramAuthController
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–∫–∞–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç `reconnect=true` –ø–∞—Ä–∞–º–µ—Ç—Ä
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π HTML —à–∞–±–ª–æ–Ω

### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –æ–ø—ã—Ç–µ

#### –î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `/auth/telegram?reconnect=true`
2. CSP –±–ª–æ–∫–∏—Ä—É–µ—Ç Telegram –≤–∏–¥–∂–µ—Ç
3. –ë–µ–ª—ã–π —ç–∫—Ä–∞–Ω / –∑–∞–≤–∏—Å–∞–Ω–∏–µ
4. –ù–∏–∫–∞–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ

#### –ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `/auth/telegram` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç—Å—è reconnect)
2. –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫—Ä–∞—Å–∏–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º Telegram
3. Telegram –≤–∏–¥–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–∏–Ω—é—é –∫–Ω–æ–ø–∫—É "Log in with Telegram"
5. –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Telegram –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
6. –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è - –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ —Å–∞–π—Ç —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π

### –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

HTML —à–∞–±–ª–æ–Ω –≤–∫–ª—é—á–∞–µ—Ç:
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
- –ü—Ä–æ–≤–µ—Ä–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞
- –û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–∂–µ—Ç–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É reconnect –ø–∞—Ä–∞–º–µ—Ç—Ä–∞

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ CSP:
1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ `/auth/telegram`
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç CSP –æ—à–∏–±–æ–∫
4. –í–∏–¥–∂–µ—Ç Telegram –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:
1. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –¥–æ–ª–∂–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Å–∏–Ω—è—è –∫–Ω–æ–ø–∫–∞ Telegram
2. –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å Telegram
3. –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ Telegram - –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ —Å–∞–π—Ç
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω

### –í–µ—Ä—Å–∏–∏
- **v1.1.1**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
- **v1.1.2**: –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è reconnect —Å—Å—ã–ª–æ–∫
- **v1.1.3**: –†–µ—à–µ–Ω–∏–µ CSP –ø—Ä–æ–±–ª–µ–º –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ HTML —à–∞–±–ª–æ–Ω–∞ ‚ú® **–¢–ï–ö–£–©–ê–Ø**

### –°—Ç–∞—Ç—É—Å
- ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**: CSP –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ Telegram –≤–∏–¥–∂–µ—Ç–∞
- ‚úÖ **–î–û–ë–ê–í–õ–ï–ù–û**: –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π HTML —à–∞–±–ª–æ–Ω –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- ‚úÖ **–£–õ–£–ß–®–ï–ù–û**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç —Å –∫—Ä–∞—Å–∏–≤—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
- ‚úÖ **–†–ï–®–ï–ù–û**: –ü—Ä–æ–±–ª–µ–º–∞ —Å –±–µ–ª—ã–º —ç–∫—Ä–∞–Ω–æ–º –∏ –∑–∞–≤–∏—Å–∞–Ω–∏–µ–º

–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: 6 –∏—é–Ω—è 2025 –≥.
