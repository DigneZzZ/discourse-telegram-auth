# üîß –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Frozen Middleware Stack in Rails 7.2+

## üìÖ –î–∞—Ç–∞: 6 –∏—é–Ω—è 2025 –≥.
## üè∑Ô∏è –í–µ—Ä—Å–∏—è: 1.1.9
## üéØ –°—Ç–∞—Ç—É—Å: –ò–°–ü–†–ê–í–õ–ï–ù–û ‚úÖ

---

## üö® –ù–û–í–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã —Å middleware –≤–æ–∑–Ω–∏–∫–ª–∞ –Ω–æ–≤–∞—è –æ—à–∏–±–∫–∞:

```
FrozenError: can't modify frozen Array: [ActionDispatch::RemoteIp, Middleware::RequestTracker, ...]
/var/www/discourse/plugins/discourse-telegram-auth/plugin.rb:326:in `rescue in block in activate!'
```

### –ü—Ä–∏—á–∏–Ω–∞
–í Rails 7.2+ —Å—Ç–µ–∫ middleware **–∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ—Ç—Å—è** –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å middleware –≤ –±–ª–æ–∫–µ `after_initialize` –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ—à–∏–±–∫–µ `FrozenError`, —Ç–∞–∫ –∫–∞–∫ –º–∞—Å—Å–∏–≤ middleware —É–∂–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω.

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### 1. –ü–µ—Ä–µ–Ω–æ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ middleware
–ü–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é middleware **–î–û** –±–ª–æ–∫–∞ `after_initialize`:

**–ë–´–õ–û (–≤—ã–∑—ã–≤–∞–ª–æ FrozenError):**
```ruby
after_initialize do
  # ...
  Rails.application.config.middleware.use TelegramCSPMiddleware  # ‚ùå –û—à–∏–±–∫–∞!
end
```

**–°–¢–ê–õ–û (—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ):**
```ruby
# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º middleware –î–û after_initialize
class ::TelegramCSPMiddleware
  def initialize(app); @app = app; end
  def call(env)
    if env['PATH_INFO'] == '/auth/telegram' || env['PATH_INFO'].start_with?('/auth/telegram')
      env['action_dispatch.content_security_policy'] = nil
      env['action_dispatch.content_security_policy_report_only'] = nil
    end
    @app.call(env)
  end
end

Rails.application.config.middleware.insert_after ActionDispatch::Flash, TelegramCSPMiddleware

after_initialize do
  # –¢–æ–ª—å–∫–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –∏ —Ä–æ—É—Ç–æ–≤
end
```

### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ç–æ—á–∫–∏ –≤—Å—Ç–∞–≤–∫–∏
–í–º–µ—Å—Ç–æ –ø–æ–ø—ã—Ç–æ–∫ –Ω–∞–π—Ç–∏ `ActionDispatch::ContentSecurityPolicy::Middleware` –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Ç–æ—á–∫—É –≤—Å—Ç–∞–≤–∫–∏ - `ActionDispatch::Flash`, –∫–æ—Ç–æ—Ä–∞—è –≤—Å–µ–≥–¥–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç.

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢

- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ FrozenError** –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ middleware
- ‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Å—Ç–∞–≤–∫–∏** - `ActionDispatch::Flash`
- ‚úÖ **–†–∞–Ω–Ω—è—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è** - –¥–æ –∑–∞–º–æ—Ä–æ–∑–∫–∏ —Å—Ç–µ–∫–∞
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - —É–±—Ä–∞–Ω—ã —Å–ª–æ–∂–Ω—ã–µ fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã

---

## üîç –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø

### –§–∞–∑—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Rails:
1. **–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏** ‚Üê Middleware –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å
2. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** ‚Üê Middleware –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å  
3. **after_initialize —Ö—É–∫–∏** ‚Üê ‚ùå Middleware —É–∂–µ –∑–∞–º–æ—Ä–æ–∂–µ–Ω
4. **–ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**

### –ù–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:
- Middleware —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ **—Ñ–∞–∑–µ 2** (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
- –†–æ—É—Ç—ã –∏ –ø–µ—Ä–µ–≤–æ–¥—ã –≤ **—Ñ–∞–∑–µ 3** (–¥–æ–ø—É—Å—Ç–∏–º–æ)

---

## üöÄ –ì–û–¢–û–í–ù–û–°–¢–¨

–ü–ª–∞–≥–∏–Ω –≤–µ—Ä—Å–∏–∏ **1.1.9** –¥–æ–ª–∂–µ–Ω —Ç–µ–ø–µ—Ä—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –≤ Discourse —Å Rails 7.2+ –±–µ–∑ –æ—à–∏–±–æ–∫ middleware.

**–¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥–∞:**
```bash
cd /var/www/discourse && su discourse -c 'bundle exec rake db:migrate'
```

---

**üéØ Middleware –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Ä–∞–Ω–Ω—é—é —Ñ–∞–∑—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏!**
